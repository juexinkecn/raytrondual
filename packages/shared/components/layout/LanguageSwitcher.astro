---
/**
 * LanguageSwitcher Component - è¯­è¨€åˆ‡æ¢å™¨
 * 
 * åŠŸèƒ½:
 * - è‹±æ–‡/ä¸­æ–‡åˆ‡æ¢
 * - å½“å‰è¯­è¨€é«˜äº®
 * - ä¿æŒå½“å‰é¡µé¢è·¯å¾„
 * - ä¸‹æ‹‰èœå•æ ·å¼
 * - å›½æ——å›¾æ ‡
 */

import { Icon } from 'astro-icon/components';

interface Props {
  lang: 'en' | 'cn';
  currentPath?: string;
  variant?: 'dropdown' | 'toggle'; // æ˜¾ç¤ºæ ·å¼å˜ä½“
}

const { lang, currentPath = '', variant = 'dropdown' } = Astro.props;

// è¯­è¨€é…ç½®
const languages = [
  {
    code: 'en',
    name: 'English',
    shortName: 'EN',
    flag: 'ğŸ‡ºğŸ‡¸',
    domain: 'https://en.raytron.group',
  },
  {
    code: 'cn',
    name: 'ä¸­æ–‡',
    shortName: 'CN',
    flag: 'ğŸ‡¨ğŸ‡³',
    domain: 'https://cn.raytron.group',
  },
];

const currentLanguage = languages.find((l) => l.code === lang);
const alternateLanguage = languages.find((l) => l.code !== lang);

// ç”Ÿæˆåˆ‡æ¢åçš„URL
const alternateUrl = alternateLanguage 
  ? `${alternateLanguage.domain}${currentPath}`
  : '#';
---

{variant === 'dropdown' ? (
  <!-- Dropdownæ ·å¼ -->
  <div class="relative group">
    <button
      type="button"
      class="
        flex items-center space-x-2 px-3 py-2 rounded-md
        text-sm font-medium text-gray-700
        hover:bg-gray-100 transition-colors
      "
      aria-label="Select language"
    >
      <span class="text-lg" role="img" aria-label={currentLanguage?.name}>
        {currentLanguage?.flag}
      </span>
      <span class="hidden sm:inline">{currentLanguage?.name}</span>
      <span class="sm:hidden">{currentLanguage?.shortName}</span>
      <Icon name="lucide:chevron-down" class="w-4 h-4" />
    </button>

    <!-- Dropdown Menu -->
    <div class="
      absolute right-0 mt-2 w-48 rounded-lg shadow-lg bg-white
      opacity-0 invisible group-hover:opacity-100 group-hover:visible
      transition-all duration-200 transform group-hover:translate-y-0 translate-y-2
      border border-gray-200 z-50
    ">
      <div class="py-1">
        {languages.map((language) => {
          const isActive = language.code === lang;
          const url = isActive ? '#' : `${language.domain}${currentPath}`;
          
          return (
            <a
              href={url}
              class={`
                flex items-center px-4 py-2 text-sm
                transition-colors
                ${isActive
                  ? 'bg-primary-50 text-primary-700 font-semibold cursor-default'
                  : 'text-gray-700 hover:bg-gray-50'
                }
              `}
              {...(isActive && { 'aria-current': 'true' })}
              hreflang={language.code}
            >
              <span class="text-lg mr-3" role="img" aria-label={language.name}>
                {language.flag}
              </span>
              <span>{language.name}</span>
              {isActive && (
                <Icon name="lucide:check" class="w-4 h-4 ml-auto text-primary-600" />
              )}
            </a>
          );
        })}
      </div>
    </div>
  </div>
) : (
  <!-- Toggleæ ·å¼ -->
  <div class="flex items-center space-x-1 bg-gray-100 rounded-lg p-1">
    {languages.map((language) => {
      const isActive = language.code === lang;
      const url = isActive ? '#' : `${language.domain}${currentPath}`;
      
      return (
        <a
          href={url}
          class={`
            flex items-center space-x-1.5 px-3 py-1.5 rounded-md
            text-sm font-medium transition-all
            ${isActive
              ? 'bg-white text-primary-600 shadow-sm'
              : 'text-gray-600 hover:text-gray-900'
            }
          `}
          {...(isActive && { 'aria-current': 'true' })}
          hreflang={language.code}
        >
          <span class="text-base" role="img" aria-label={language.name}>
            {language.flag}
          </span>
          <span>{language.shortName}</span>
        </a>
      );
    })}
  </div>
)}

<style>
  /* å¹³æ»‘è¿‡æ¸¡ */
  .group > div {
    pointer-events: none;
  }

  .group:hover > div {
    pointer-events: auto;
  }

  /* ç¡®ä¿åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½ç‚¹å‡» */
  @media (hover: none) {
    .group > div {
      pointer-events: auto;
    }
  }
</style>

<script>
  // ç§»åŠ¨ç«¯ç‚¹å‡»åˆ‡æ¢è¯­è¨€èœå•
  document.addEventListener('DOMContentLoaded', () => {
    const languageButton = document.querySelector('[aria-label="Select language"]');
    const languageMenu = languageButton?.nextElementSibling;

    if (languageButton && languageMenu && 'ontouchstart' in window) {
      let isMenuOpen = false;

      languageButton.addEventListener('click', (e) => {
        e.preventDefault();
        isMenuOpen = !isMenuOpen;

        if (isMenuOpen) {
          languageMenu.classList.remove('opacity-0', 'invisible', 'translate-y-2');
          languageMenu.classList.add('opacity-100', 'visible', 'translate-y-0');
        } else {
          languageMenu.classList.add('opacity-0', 'invisible', 'translate-y-2');
          languageMenu.classList.remove('opacity-100', 'visible', 'translate-y-0');
        }
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
      document.addEventListener('click', (e) => {
        if (!languageButton.contains(e.target as Node) && !languageMenu.contains(e.target as Node)) {
          if (isMenuOpen) {
            isMenuOpen = false;
            languageMenu.classList.add('opacity-0', 'invisible', 'translate-y-2');
            languageMenu.classList.remove('opacity-100', 'visible', 'translate-y-0');
          }
        }
      });
    }
  });
</script>
